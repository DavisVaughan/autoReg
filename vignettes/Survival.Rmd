---
title: "Survival Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Survival Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = NA
)
```


## Background

In healthcare, we deal with a lot of binary outcomes. Death yes/no, disease recurrence yes/no, for instance. These outcomes are often easily analysed using binary logistic regression using glm(...,family="binomial). 

When the time taken for the outcome to occur is important, we need a different approach. For instance, in patients with cancer, the time taken until recurrence of the cancer is often just as important as the fact it has recurred.

Package autoReg provides a number of functions to make these analyses easy to perform.

When writing package autoReg and this vignette, I was inspired from package finalfit by Ewen Harrison. 

## Installation

You can install autoReg package on github. 

```{r, eval=FALSE}
#install.packages("devtools")
devtools::install_github("cardiomoon/autoReg")
```

## Load package

To load the package, use library() function.
```{r}
library(autoReg)
library(survival)
library(dplyr)
```

## Data `melanoma`

We will use the classic “Survival from Malignant Melanoma” dataset which is included in the boot package. The data consist of measurements made on patients with malignant melanoma. Each patient had their tumour removed by surgery at the Department of Plastic Surgery, University Hospital of Odense, Denmark during the period 1962 to 1977.

```{r}
data(melanoma,package="boot")
gaze(melanoma)
```

We are interested in the association between tumor ulceration and survival after surgery.

The patient status at the end of study was coded in status variable. 

- 1 indicates that they had died from melanoma 
- 2 indicates that they were still alive 
- 3 indicates that they had died from causes unrelated to their melanoma.

There are three options for coding this.

- Overall survival: considering all-cause mortality, comparing 2 (alive) with 1 (died melanoma)/3 (died other) by logical expression status!=2 (e.g. status is not equal to 2)
- Cause-specific survival: considering disease-specific mortality comparing 2 (alive)/3 (died other) with 1 (died melanoma) by status==1 (e.g. status is equal to 1 )
- Competing risks: comparing 2 (alive) with 1 (died melanoma) accounting for 3 (died other); So we will make a new variable `statusCRR` 


The `sex` variable in melanoma is coded as 0=female and 1=male. The `ulcer` variable is coded as 1=present and 2= absent. It is possible to use this variables during analysis, but we change these variables to factor with proper labels(just for aesthetic purpose).

```{r}
melanoma$statusCRR = ifelse(melanoma$status==1,1,ifelse(melanoma$status==2,0,2))
melanoma$sex=factor(melanoma$sex,labels=c("Female","Male"))
melanoma$ulcer=factor(melanoma$ulcer,labels=c("Absent","Present"))
```

```{r}
gaze(melanoma,show.n=TRUE)
```



```{r}
fit=survfit(Surv(time/365,status!=2)~1,data=melanoma)
summary(fit,time=0:5)

library(survminer)
ggsurvplot(fit,pval=TRUE,risk.table=TRUE)
```

```{r}
fit=coxph(Surv(time,status!=2)~age+sex+thickness+ulcer,data=melanoma)
```

```{r}
x=autoReg(fit,uni=TRUE,threshold=1)
x %>% myft()
```
If you want, you can decorate your table as follows:

```{r}
x$name=c("Age(years)","Sex","","Tumor thickness (mm)","Tumor thickness (mm)","")
names(x)[1]="Overall Survival"
x %>% myft()
```
If you want to add another model summary to the table, the addFitSummary() can do this.
```{r}
final=coxph(Surv(time,status!=2)~age+thickness+ulcer,data=melanoma)
x=x %>% addFitSummary(final,statsname="HR (reduced)") 
x %>% myft()
```
#### Testing for proportional hazards

An assumption of CPH regression is that the hazard (think risk) associated with a particular variable does not change over time. For example, is the magnitude of the increase in risk of death associated with tumour ulceration the same in the early post-operative period as it is in later years?

The cox.zph() function from the survival package allows us to test this assumption for each variable. The plot of scaled Schoenfeld residuals should be a horizontal line. The included hypothesis test identifies whether the gradient differs from zero for each variable. No variable significantly differs from zero at the 5% significance level.

```{r}
fit=coxph(Surv(time,status!=2)~age+sex+thickness+ulcer,data=melanoma)
result=cox.zph(fit)
result
```
```{r,fig.width=8,fig.height=6}
survminer::ggcoxzph(result)
```

#### Stratified models

One approach to dealing with a violation of the proportional hazards assumption is to stratify by that variable. Including a strata() term will result in a separate baseline hazard function being fit for each level in the stratification variable. It will be no longer possible to make direct inference on the effect associated with that variable.

```{r}
fit=coxph(Surv(time,status!=2)~age+sex+ulcer+thickness+strata(year),data=melanoma)
autoReg(fit) %>% myft()
```
### Correlated groups of observations

As a general rule, you should always try to account for any higher structure in your data within the model. For instance, patients may be clustered within particular hospitals.

There are two broad approaches to dealing with correlated groups of observations.

A cluster() term implies a generalised estimating equations (GEE) approach. Here, a standard CPH model is fitted but the standard errors of the estimated hazard ratios are adjusted to account for correlations.

```{r}
# Simulate random hospital identifier
melanoma$hospital_id= c(rep(1:10, 20), rep(11, 5))
str(melanoma)
fit=coxph(Surv(time,status!=2)~age+sex+ulcer+thickness+cluster(hospital_id),data=melanoma)
autoReg(fit,uni=TRUE,threshold=1) %>% myft()
```

A frailty() term implies a mixed effects model, where specific random effects term(s) are directly incorporated into the model.

```{r}
fit=coxph(Surv(time,status!=2)~age+sex+ulcer+thickness+frailty(hospital_id),data=melanoma)
autoReg(fit,uni=TRUE,threshold=1) %>% myft()
```
Both approaches achieve the same goal in different ways. Volumes have been written on GEE vs mixed effects models. We favour the latter approach because of its flexibility and our preference for mixed effects modelling in generalised linear modelling. Note cluster() and frailty() terms cannot be combined in the same model.

#### Hazard ratio plot : modelPlot()

You can draw hazard ratio plot

```{r,fig.width=8,fig.height=6}
modelPlot(fit)
```

### Disease-specific survival

```{r}
fit=coxph(Surv(time,status==1)~age+sex+thickness+ulcer,data=melanoma)
autoReg(fit,uni=TRUE,threshold=1) %>% myft()
```

### Competing risk regression

Competing-risks regression is an alternative to CPH regression. It can be useful if the outcome of interest may not be able to occur simply because something else (like death) has happened first. For instance, in our example it is obviously not possible for a patient to die from melanoma if they have died from another disease first. By simply looking at cause-specific mortality (deaths from melanoma) and considering other deaths as censored, bias may result in estimates of the influence of predictors.

The approach by Fine and Gray is one option for dealing with this. It is implemented in the package `cmprsk`. The crrFormula() function in autoReg package can make competing risk regression model and addFitSummary() function can add the model summary.

```{r}
fit1=crrFormula(time+statusCRR~age+sex+thickness+ulcer,data=melanoma)
autoReg(fit,uni=TRUE,threshold=1) %>% 
  addFitSummary(fit1,"HR (competing risks multivariable)") %>% 
  myft()
```

